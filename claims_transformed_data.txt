CREATE OR REPLACE PROCEDURE `insuretec_Transform_Data.proc_transformation_claim`()
BEGIN
 
  --CLAIMS DATA LOGIC
 
  -- TRANSFORMED TABLE NAMING CONVENTION LOGIC
  DECLARE raw_table_name STRING;
  DECLARE transformed_table_name STRING;
  DECLARE column_str STRING;
 
  SET raw_table_name = 'insuretec_Raw_Data.raw_claims';
  SET transformed_table_name = 'insuretec_Transform_Data.claim_mapping_data';
  SET column_str = '';
 
  -- MAIN LOGIC
  FOR mapping_row IN (
      SELECT * FROM insuretec_raw_to_transform_column_mapping.claim_column_name_mapping_table
  ) DO
      SET column_str = CONCAT(column_str, '"', mapping_row.client_raw_column, '" AS `', mapping_row.predoole_master, '`,');
  END FOR;
 
  -- REMOVE TRAILING COMMA
  SET column_str = SUBSTR(column_str, 1, LENGTH(column_str) - 1);
 
  -- EXECUTE STATEMENT TO CREATE MAPPING TABLE
  EXECUTE IMMEDIATE CONCAT('CREATE TABLE ', transformed_table_name, ' AS SELECT ', column_str, 'FROM ', raw_table_name);
 
  -- IF ANY COLUMNS ARE ADDED IN MAIN DATA THEN WE NEED TO ADD THEM IN BELOW CAST PROCESS
  -- MAIN LOGIC
  IF ((
      SELECT COUNT(*)
      FROM insuretec_Transform_Data.INFORMATION_SCHEMA.TABLES
      WHERE table_name = 'Claims_Transformed_Data'
  ) = 0) THEN
    CREATE OR REPLACE TABLE insuretec_Transform_Data.Claims_Transformed_Data AS
    SELECT
   
        SAFE_CAST(Channel AS STRING) AS Channel,
    SAFE_CAST(AsOnDate AS DATE) AS AsOnDate,
    SAFE_CAST(CL_STATUS AS STRING) AS CL_STATUS,
    SAFE_CAST(CLAIM_NO AS STRING) AS CLAIM_NO,
    SAFE_CAST(OUTSTNDG AS FLOAT64) AS OUTSTNDG,
    SAFE_CAST(REported_date AS DATE) AS REported_date,
    SAFE_CAST(STATECODE AS STRING) AS STATECODE,
    SAFE_CAST(STATENAME AS STRING) AS STATENAME,
    SAFE_CAST(Product_Code AS STRING) AS Product_Code,
    SAFE_CAST(CLM_CLOSED AS DATE) AS CLM_CLOSED,
    SAFE_CAST(PAID_FY AS FLOAT64) AS PAID_FY,
    SAFE_CAST(PAID_LOSS AS FLOAT64) AS PAID_LOSS,
    SAFE_CAST(POLICY_NO AS STRING) AS POLICY_NO,
    SAFE_CAST(REGDATE AS DATE) AS REGDATE,
    SAFE_CAST(STATUS AS INT64) AS STATUS,
    SAFE_CAST(UIN AS INT64) AS UIN,
    SAFE_CAST(Claim_Type AS STRING) AS Claim_Type,
    SAFE_CAST(OD_Total_Loss AS STRING) AS OD_Total_Loss,
    SAFE_CAST(OD_Expenses_Paid AS FLOAT64) AS OD_Expenses_Paid,
    SAFE_CAST(Boo_Litigation AS STRING) AS Boo_Litigation,
    SAFE_CAST(New_Reopened_Claims AS STRING) AS New_Reopened_Claims,
    SAFE_CAST(Catastrophe AS STRING) AS Catastrophe,
    SAFE_CAST(Claims_Paid_Labor AS INT64) AS Claims_Paid_Labor,
    SAFE_CAST(Claims_Paid_Part AS INT64) AS Claims_Paid_Part,
    SAFE_CAST(Date_Recovery AS DATE) AS Date_Recovery,
    SAFE_CAST(Vehicle_Taken_By_Insurer AS STRING) AS Vehicle_Taken_By_Insurer,
    SAFE_CAST(Salvage_Value AS INT64) AS Salvage_Value,
    SAFE_CAST(Pay_Recover AS STRING) AS Pay_Recover,
    SAFE_CAST(Compromised_or_Award AS STRING) AS Compromised_or_Award,
    SAFE_CAST(New_or_Reopened_Claim AS STRING) AS New_or_Reopened_Claim,
    SAFE_CAST(Orphan_Claims AS STRING) AS Orphan_Claims,
    SAFE_CAST(IIB_NOL_Code AS INT64) AS IIB_NOL_Code,
    SAFE_CAST(TP_Expenses_Paid AS FLOAT64) AS TP_Expenses_Paid,
    SAFE_CAST(TP_Interest_Paid AS FLOAT64) AS TP_Interest_Paid,
    SAFE_CAST(Amount_PA_Owner_Driver AS FLOAT64) AS Amount_PA_Owner_Driver,
    SAFE_CAST(Amount_PA_Others AS FLOAT64) AS Amount_PA_Others,
    SAFE_CAST(Nature_Of_Injury AS INT64) AS Nature_Of_Injury,
    SAFE_CAST(Open_Provision_Main AS FLOAT64) AS Open_Provision_Main,
    SAFE_CAST(Open_Provision_Expenses AS FLOAT64) AS Open_Provision_Expenses,
    SAFE_CAST(Open_Provision_Interest AS FLOAT64) AS Open_Provision_Interest,
    SAFE_CAST(Closing_Provision_Main AS FLOAT64) AS Closing_Provision_Main,
    SAFE_CAST(Closing_Provision_Expenses AS FLOAT64) AS Closing_Provision_Expenses,
    SAFE_CAST(Closing_Provision_Interest AS FLOAT64) AS Closing_Provision_Interest,
    SAFE_CAST(Driver_License_Number AS STRING) AS Driver_License_Number,
    SAFE_CAST(Summons_Type_Code AS INT64) AS Summons_Type_Code,
    SAFE_CAST(Age AS INT64) AS Age,
    SAFE_CAST(Sex AS STRING) AS Sex,
    SAFE_CAST(Cur_Annual_Income AS FLOAT64) AS Cur_Annual_Income,
    SAFE_CAST(Occupation_Code AS INT64) AS Occupation_Code,
    SAFE_CAST(Nature_Of_Injury_desc AS STRING) AS Nature_Of_Injury_desc,
    SAFE_CAST(Disability_Percentage AS FLOAT64) AS Disability_Percentage,
    SAFE_CAST(Income_Loss_Days AS INT64) AS Income_Loss_Days,
    SAFE_CAST(Interest_Rate AS FLOAT64) AS Interest_Rate,
    SAFE_CAST(District_Accident AS INT64) AS District_Accident,
    SAFE_CAST(Award_General_Damages_Paid AS FLOAT64) AS Award_General_Damages_Paid,
    SAFE_CAST(Award_Special_Damages_Paid AS FLOAT64) AS Award_Special_Damages_Paid,
    SAFE_CAST(Court_Location_Code AS INT64) AS Court_Location_Code,
    SAFE_CAST(Issuing_RTO_Driver_License AS INT64) AS Issuing_RTO_Driver_License
   
 
    FROM insuretec_Transform_Data.claim_mapping_data
    GROUP BY
 
        Channel,
          AsOnDate,
          CL_STATUS,
          CLAIM_NO,
          OUTSTNDG,
          REported_date,
          STATECODE,
          STATENAME,
          Product_Code,
          CLM_CLOSED,
          PAID_FY,
          PAID_LOSS,
          POLICY_NO,
          REGDATE,
          STATUS,
          UIN,
          Claim_Type,
          OD_Total_Loss,
          OD_Expenses_Paid,
          Boo_Litigation,
          New_Reopened_Claims,
          Catastrophe,
          Claims_Paid_Labor,
          Claims_Paid_Part,
          Date_Recovery,
          Vehicle_Taken_By_Insurer,
          Salvage_Value,
          Pay_Recover,
          Compromised_or_Award,
          New_or_Reopened_Claim,
          Orphan_Claims,
          IIB_NOL_Code,
          TP_Expenses_Paid,
          TP_Interest_Paid,
          Amount_PA_Owner_Driver,
          Amount_PA_Others,
          Nature_Of_Injury,
          Open_Provision_Main,
          Open_Provision_Expenses,
          Open_Provision_Interest,
          Closing_Provision_Main,
          Closing_Provision_Expenses,
          Closing_Provision_Interest,
          Driver_License_Number,
          Summons_Type_Code,
          Age,
          Sex,
          Cur_Annual_Income,
          Occupation_Code,
          Nature_Of_Injury_desc,
          Disability_Percentage,
          Income_Loss_Days,
          Interest_Rate,
          District_Accident,
          Award_General_Damages_Paid,
          Award_Special_Damages_Paid,
          Court_Location_Code,
          Issuing_RTO_Driver_License;
 
  ELSE
      -- ELSE STATEMENT WITH INSERTION DATA PROCESS STATEMENT
      INSERT INTO insuretec_Transform_Data.Claims_Transformed_Data (
          Channel,
          AsOnDate,
          CL_STATUS,
          CLAIM_NO,
          OUTSTNDG,
          REported_date,
          STATECODE,
          STATENAME,
          Product_Code,
          CLM_CLOSED,
          PAID_FY,
          PAID_LOSS,
          POLICY_NO,
          REGDATE,
          STATUS,
          UIN,
          Claim_Type,
          OD_Total_Loss,
          OD_Expenses_Paid,
          Boo_Litigation,
          New_Reopened_Claims,
          Catastrophe,
          Claims_Paid_Labor,
          Claims_Paid_Part,
          Date_Recovery,
          Vehicle_Taken_By_Insurer,
          Salvage_Value,
          Pay_Recover,
          Compromised_or_Award,
          New_or_Reopened_Claim,
          Orphan_Claims,
          IIB_NOL_Code,
          TP_Expenses_Paid,
          TP_Interest_Paid,
          Amount_PA_Owner_Driver,
          Amount_PA_Others,
          Nature_Of_Injury,
          Open_Provision_Main,
          Open_Provision_Expenses,
          Open_Provision_Interest,
          Closing_Provision_Main,
          Closing_Provision_Expenses,
          Closing_Provision_Interest,
          Driver_License_Number,
          Summons_Type_Code,
          Age,
          Sex,
          Cur_Annual_Income,
          Occupation_Code,
          Nature_Of_Injury_desc,
          Disability_Percentage,
          Income_Loss_Days,
          Interest_Rate,
          District_Accident,
          Award_General_Damages_Paid,
          Award_Special_Damages_Paid,
          Court_Location_Code,
          Issuing_RTO_Driver_License
      )
      SELECT
        SAFE_CAST(Channel AS STRING) AS Channel,
    SAFE_CAST(AsOnDate AS DATE) AS AsOnDate,
    SAFE_CAST(CL_STATUS AS STRING) AS CL_STATUS,
    SAFE_CAST(CLAIM_NO AS STRING) AS CLAIM_NO,
    SAFE_CAST(OUTSTNDG AS FLOAT64) AS OUTSTNDG,
    SAFE_CAST(REported_date AS DATE) AS REported_date,
    SAFE_CAST(STATECODE AS STRING) AS STATECODE,
    SAFE_CAST(STATENAME AS STRING) AS STATENAME,
    SAFE_CAST(Product_Code AS STRING) AS Product_Code,
    SAFE_CAST(CLM_CLOSED AS DATE) AS CLM_CLOSED,
    SAFE_CAST(PAID_FY AS FLOAT64) AS PAID_FY,
    SAFE_CAST(PAID_LOSS AS FLOAT64) AS PAID_LOSS,
    SAFE_CAST(POLICY_NO AS STRING) AS POLICY_NO,
    SAFE_CAST(REGDATE AS DATE) AS REGDATE,
    SAFE_CAST(STATUS AS INT64) AS STATUS,
    SAFE_CAST(UIN AS INT64) AS UIN,
    SAFE_CAST(Claim_Type AS STRING) AS Claim_Type,
    SAFE_CAST(OD_Total_Loss AS STRING) AS OD_Total_Loss,
    SAFE_CAST(OD_Expenses_Paid AS FLOAT64) AS OD_Expenses_Paid,
    SAFE_CAST(Boo_Litigation AS STRING) AS Boo_Litigation,
    SAFE_CAST(New_Reopened_Claims AS STRING) AS New_Reopened_Claims,
    SAFE_CAST(Catastrophe AS STRING) AS Catastrophe,
    SAFE_CAST(Claims_Paid_Labor AS INT64) AS Claims_Paid_Labor,
    SAFE_CAST(Claims_Paid_Part AS INT64) AS Claims_Paid_Part,
    SAFE_CAST(Date_Recovery AS DATE) AS Date_Recovery,
    SAFE_CAST(Vehicle_Taken_By_Insurer AS STRING) AS Vehicle_Taken_By_Insurer,
    SAFE_CAST(Salvage_Value AS INT64) AS Salvage_Value,
    SAFE_CAST(Pay_Recover AS STRING) AS Pay_Recover,
    SAFE_CAST(Compromised_or_Award AS STRING) AS Compromised_or_Award,
    SAFE_CAST(New_or_Reopened_Claim AS STRING) AS New_or_Reopened_Claim,
    SAFE_CAST(Orphan_Claims AS STRING) AS Orphan_Claims,
    SAFE_CAST(IIB_NOL_Code AS INT64) AS IIB_NOL_Code,
    SAFE_CAST(TP_Expenses_Paid AS FLOAT64) AS TP_Expenses_Paid,
    SAFE_CAST(TP_Interest_Paid AS FLOAT64) AS TP_Interest_Paid,
    SAFE_CAST(Amount_PA_Owner_Driver AS FLOAT64) AS Amount_PA_Owner_Driver,
    SAFE_CAST(Amount_PA_Others AS FLOAT64) AS Amount_PA_Others,
    SAFE_CAST(Nature_Of_Injury AS INT64) AS Nature_Of_Injury,
    SAFE_CAST(Open_Provision_Main AS FLOAT64) AS Open_Provision_Main,
    SAFE_CAST(Open_Provision_Expenses AS FLOAT64) AS Open_Provision_Expenses,
    SAFE_CAST(Open_Provision_Interest AS FLOAT64) AS Open_Provision_Interest,
    SAFE_CAST(Closing_Provision_Main AS FLOAT64) AS Closing_Provision_Main,
    SAFE_CAST(Closing_Provision_Expenses AS FLOAT64) AS Closing_Provision_Expenses,
    SAFE_CAST(Closing_Provision_Interest AS FLOAT64) AS Closing_Provision_Interest,
    SAFE_CAST(Driver_License_Number AS STRING) AS Driver_License_Number,
    SAFE_CAST(Summons_Type_Code AS INT64) AS Summons_Type_Code,
    SAFE_CAST(Age AS INT64) AS Age,
    SAFE_CAST(Sex AS STRING) AS Sex,
    SAFE_CAST(Cur_Annual_Income AS FLOAT64) AS Cur_Annual_Income,
    SAFE_CAST(Occupation_Code AS INT64) AS Occupation_Code,
    SAFE_CAST(Nature_Of_Injury_desc AS STRING) AS Nature_Of_Injury_desc,
    SAFE_CAST(Disability_Percentage AS FLOAT64) AS Disability_Percentage,
    SAFE_CAST(Income_Loss_Days AS INT64) AS Income_Loss_Days,
    SAFE_CAST(Interest_Rate AS FLOAT64) AS Interest_Rate,
    SAFE_CAST(District_Accident AS INT64) AS District_Accident,
    SAFE_CAST(Award_General_Damages_Paid AS FLOAT64) AS Award_General_Damages_Paid,
    SAFE_CAST(Award_Special_Damages_Paid AS FLOAT64) AS Award_Special_Damages_Paid,
    SAFE_CAST(Court_Location_Code AS INT64) AS Court_Location_Code,
    SAFE_CAST(Issuing_RTO_Driver_License AS INT64) AS Issuing_RTO_Driver_License
 
      FROM `insuretec_Transform_Data`.`claim_mapping_data`
      GROUP BY
          Channel,
          AsOnDate,
          CL_STATUS,
          CLAIM_NO,
          OUTSTNDG,
          REported_date,
          STATECODE,
          STATENAME,
          Product_Code,
          CLM_CLOSED,
          PAID_FY,
          PAID_LOSS,
          POLICY_NO,
          REGDATE,
          STATUS,
          UIN,
          Claim_Type,
          OD_Total_Loss,
          OD_Expenses_Paid,
          Boo_Litigation,
          New_Reopened_Claims,
          Catastrophe,
          Claims_Paid_Labor,
          Claims_Paid_Part,
          Date_Recovery,
          Vehicle_Taken_By_Insurer,
          Salvage_Value,
          Pay_Recover,
          Compromised_or_Award,
          New_or_Reopened_Claim,
          Orphan_Claims,
          IIB_NOL_Code,
          TP_Expenses_Paid,
          TP_Interest_Paid,
          Amount_PA_Owner_Driver,
          Amount_PA_Others,
          Nature_Of_Injury,
          Open_Provision_Main,
          Open_Provision_Expenses,
          Open_Provision_Interest,
          Closing_Provision_Main,
          Closing_Provision_Expenses,
          Closing_Provision_Interest,
          Driver_License_Number,
          Summons_Type_Code,
          Age,
          Sex,
          Cur_Annual_Income,
          Occupation_Code,
          Nature_Of_Injury_desc,
          Disability_Percentage,
          Income_Loss_Days,
          Interest_Rate,
          District_Accident,
          Award_General_Damages_Paid,
          Award_Special_Damages_Paid,
          Court_Location_Code,
          Issuing_RTO_Driver_License;
 
  END IF;
 
  -- DROP STATEMENT
  -- EXECUTE STATEMENT FOR DROPPING MAPPING TABLE
  EXECUTE IMMEDIATE CONCAT('DROP TABLE IF EXISTS ', transformed_table_name);
 
END;